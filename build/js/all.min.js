angular.module("angularCharts",["angularChartsTemplates"]),angular.module("angularCharts").directive("acChart",["$templateCache","$compile","$rootElement","$window","$timeout",function(t,n,e,a,r){function i(){for(var t="0123456789ABCDEF".split(""),n="#",e=0;6>e;e++)n+=t[Math.round(15*Math.random())];return n}function o(t,n){var e=null;for(var a in t)if(angular.isElement(t[a])&&(e=angular.element(t[a]),e.hasClass(n)))return e;return e}function l(l,c){function u(){p(),d(),f();var t=g(W);t(),C()}function d(){if(!M.legend.display)return F=R,void(O=A);switch(M.legend.position){case"top":case"bottom":F=.75*R,O=A;break;case"left":case"right":F=R,O=.75*A}}function f(){var e=t.get(M.legend.position);c.html(e),n(c.contents())(l);var a=c.find("div");H=o(a,"ac-chart"),L=o(a,"ac-legend"),F-=o(a,"ac-title")[0].clientHeight}function p(){B=l.acData,W=l.acChart,D=B?B.series||[]:[],T=B?B.data||[]:[],l.acConfig&&(angular.extend(M,l.acConfig),M.colors=M.colors.concat(z))}function g(t){var n={pie:y,bar:m,line:v,area:x,point:b};return n[t]}function h(t,n){var e=n.domain();if(M.xAxisMaxTicks&&e.length>M.xAxisMaxTicks){var a=Math.ceil(e.length/M.xAxisMaxTicks);t.tickValues(e.filter(function(t,n){return n%a==0}))}}function m(){var t={top:0,right:20,bottom:30,left:40};O-=t.left+t.right,F-=t.top+t.bottom;var n=d3.scale.ordinal().rangeRoundBands([0,O],.1),e=d3.scale.linear().range([F,10]),a=d3.scale.ordinal().rangeRoundBands([0,O],.1),r=[0];T.forEach(function(t){t.nicedata=t.y.map(function(n,e){return r.push(n),{x:t.x,y:n,s:e,tooltip:angular.isArray(t.tooltip)?t.tooltip[e]:t.tooltip}})});var i=d3.max(T.map(function(t){return t.y.length}));l.yMaxData=i,n.domain(T.map(function(t){return t.x}));var o=.2*d3.max(r);e.domain([d3.min(r),d3.max(r)+o]),a.domain(d3.range(i)).rangeRoundBands([0,n.rangeBand()]);var s=d3.svg.axis().scale(n).orient("bottom");h(s,n);var c=d3.svg.axis().scale(e).orient("left").ticks(10).tickFormat(d3.format("s")),u=d3.select(H[0]).append("svg").attr("width",O+t.left+t.right).attr("height",F+t.top+t.bottom).append("g").attr("transform","translate("+t.left+","+t.top+")");u.append("g").attr("class","x axis").attr("transform","translate(0,"+F+")").call(s),u.append("g").attr("class","y axis").call(c);var d=u.selectAll(".state").data(T).enter().append("g").attr("class","g").attr("transform",function(t){return"translate("+n(t.x)+",0)"}),f=d.selectAll("rect").data(function(t){return t.nicedata}).enter().append("rect");f.attr("width",a.rangeBand()),f.attr("x",function(t,n){return a(n)}).attr("y",F).style("fill",function(t){return E(t.s)}).attr("height",0).transition().ease("cubic-in-out").duration(1e3).attr("y",function(t){return e(Math.max(0,t.y))}).attr("height",function(t){return Math.abs(e(t.y)-e(0))}),f.on("mouseover",function(t){k({value:t.y,series:D[t.s],index:t.x},d3.event),M.mouseover(t,d3.event),l.$apply()}).on("mouseleave",function(t){w(),M.mouseout(t,d3.event),l.$apply()}).on("mousemove",function(){$(d3.event)}).on("click",function(t){M.click.call(t,d3.event),l.$apply()}),M.labels&&d.selectAll("not-a-class").data(function(t){return t.nicedata}).enter().append("text").attr("x",function(t,n){return a(n)}).attr("y",function(t){return F-Math.abs(e(t.y)-e(0))}).text(function(t){return t.y}),u.append("line").attr("x1",O).attr("y1",e(0)).attr("y2",e(0)).style("stroke","silver")}function v(){function t(t){return Math.round(e(t))+e.rangeBand()/2}var n={top:0,right:40,bottom:20,left:40};O-=n.left+n.right,F-=n.top+n.bottom;var e=d3.scale.ordinal().domain(T.map(function(t){return t.x})).rangeRoundBands([0,O]),a=d3.scale.linear().range([F,10]),r=d3.svg.axis().scale(e).orient("bottom");h(r,e);var i=d3.svg.axis().scale(a).orient("left").ticks(5).tickFormat(d3.format("s")),o=d3.svg.line().interpolate("cardinal").x(function(n){return t(n.x)}).y(function(t){return a(t.y)}),s=[0],c=[];T.forEach(function(t){t.y.map(function(t){s.push(t)})});var u=d3.max(T.map(function(t){return t.y.length}));l.yMaxData=u,D.slice(0,u).forEach(function(t,n){var e={};e.series=t,e.values=T.map(function(t){return t.y.map(function(n){return{x:t.x,y:n}})[n]||{x:T[n].x,y:0}}),c.push(e)});var d=d3.select(H[0]).append("svg").attr("width",O+n.left+n.right).attr("height",F+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")"),f=.2*d3.max(s);a.domain([d3.min(s),d3.max(s)+f]),d.append("g").attr("class","x axis").attr("transform","translate(0,"+F+")").call(r),d.append("g").attr("class","y axis").call(i);var p=d.selectAll(".points").data(c).enter().append("g");if(path=p.attr("points","points").append("path").attr("class","ac-line").style("stroke",function(t,n){return E(n)}).attr("d",function(t){return o(t.values)}).attr("stroke-width","2").attr("fill","none"),c.length>0){var g=c[c.length-1].values;if(g.length>0){var m=path.node().getTotalLength()+t(g[g.length-1].x);path.attr("stroke-dasharray",m+" "+m).attr("stroke-dashoffset",m).transition().duration(1500).ease("linear").attr("stroke-dashoffset",0).attr("d",function(t){return o(t.values)})}}return angular.forEach(c,function(n){var e=d.selectAll(".circle").data(n.values).enter();e.append("circle").attr("cx",function(n){return t(n.x)}).attr("cy",function(t){return a(t.y)}).attr("r",3).style("fill",E(c.indexOf(n))).style("stroke",E(c.indexOf(n))).on("mouseover",function(t){return function(n){k({index:n.x,value:n.y,series:t},d3.event),M.mouseover(n,d3.event),l.$apply()}}(n.series)).on("mouseleave",function(t){w(),M.mouseout(t,d3.event),l.$apply()}).on("mousemove",function(){$(d3.event)}).on("click",function(t){M.click(t,d3.event),l.$apply()}),M.labels&&e.append("text").attr("x",function(n){return t(n.x)}).attr("y",function(t){return a(t.y)}).text(function(t){return t.y})}),"lineEnd"===M.lineLegend&&p.append("text").datum(function(t){return{name:t.series,value:t.values[t.values.length-1]}}).attr("transform",function(n){return"translate("+t(n.value.x)+","+a(n.value.y)+")"}).attr("x",3).text(function(t){return t.name}),c}function x(){function t(t){return Math.round(e(t))+e.rangeBand()/2}var n={top:0,right:40,bottom:20,left:40};O-=n.left+n.right,F-=n.top+n.bottom;var e=d3.scale.ordinal().domain(T.map(function(t){return t.x})).rangeRoundBands([0,O]),a=d3.scale.linear().range([F,10]),r=d3.svg.axis().scale(e).orient("bottom");h(r,e);var i=d3.svg.axis().scale(a).orient("left").ticks(5).tickFormat(d3.format("s")),o=(d3.svg.line().interpolate("cardinal").x(function(n){return t(n.x)}).y(function(t){return a(t.y)}),[0]),s=[];T.forEach(function(t){t.y.map(function(t){o.push(t)})});var c=d3.max(T.map(function(t){return t.y.length}));l.yMaxData=c,D.slice(0,c).forEach(function(t,n){var e={};e.series=t,e.values=T.map(function(t){return t.y.map(function(n){return{x:t.x,y:n}})[n]||{x:T[n].x,y:0}}),s.push(e)});var u=d3.select(H[0]).append("svg").attr("width",O+n.left+n.right).attr("height",F+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")"),d=.2*d3.max(o);a.domain([d3.min(o),d3.max(o)+d]),u.append("g").attr("class","x axis").attr("transform","translate(0,"+F+")").call(r),u.append("g").attr("class","y axis").call(i);var f=u.selectAll(".points").data(s).enter().append("g"),p=d3.svg.area().interpolate("basis").x(function(n){return t(n.x)}).y0(function(){return a(0)}).y1(function(t){return a(0+t.y)});f.append("path").attr("class","area").attr("d",function(t){return p(t.values)}).style("fill",function(t,n){return E(n)}).style("opacity","0.7")}function y(){function t(t){t.innerRadius=0;var n=d3.interpolate({startAngle:0,endAngle:0},t);return function(t){return i(n(t))}}var n=Math.min(O,F)/2,e=d3.select(H[0]).append("svg").attr("width",O).attr("height",F).append("g").attr("transform","translate("+O/2+","+F/2+")"),a=0;if(M.innerRadius){var r=M.innerRadius;"string"==typeof r&&r.indexOf("%")>0&&(r=n*(1-.01*parseFloat(r))),r&&(a=n-Number(r))}l.yMaxData=T.length;{var i=d3.svg.arc().outerRadius(n-10).innerRadius(a),o=(d3.svg.arc().outerRadius(n+5).innerRadius(0),d3.layout.pie().sort(null).value(function(t){return t.y[0]})),s=e.selectAll(".arc").data(o(T)).enter().append("g"),c=!1;s.append("path").style("fill",function(t,n){return E(n)}).transition().ease("linear").duration(500).attrTween("d",t).attr("class","arc").each("end",function(){c||(c=!0,s.on("mouseover",function(t){k({value:t.data.y[0]},d3.event),d3.select(this).select("path").transition().duration(200).style("stroke","white").style("stroke-width","2px"),M.mouseover(t,d3.event),l.$apply()}).on("mouseleave",function(t){d3.select(this).select("path").transition().duration(200).style("stroke","").style("stroke-width",""),w(),M.mouseout(t,d3.event),l.$apply()}).on("mousemove",function(){$(d3.event)}).on("click",function(t){M.click(t,d3.event),l.$apply()}))})}M.labels&&s.append("text").attr("transform",function(t){return"translate("+i.centroid(t)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(t){return t.data.y[0]})}function b(){function t(t){return Math.round(e(t))+e.rangeBand()/2}var n={top:0,right:40,bottom:20,left:40};O-=n.left-n.right,F-=n.top-n.bottom;var e=d3.scale.ordinal().domain(T.map(function(t){return t.x})).rangeRoundBands([0,O]),a=d3.scale.linear().range([F,10]),r=d3.svg.axis().scale(e).orient("bottom");h(r,e);var i=d3.svg.axis().scale(a).orient("left").ticks(5).tickFormat(d3.format("s")),o=[0],s=[];T.forEach(function(t){t.y.map(function(t){o.push(t)})});var c=d3.max(T.map(function(t){return t.y.length}));l.yMaxPoints=c,D.slice(0,c).forEach(function(t,n){var e={};e.series=t,e.values=T.map(function(t){return t.y.map(function(n){return{x:t.x,y:n}})[n]||{x:T[n].x,y:0}}),s.push(e)});var u=d3.select(H[0]).append("svg").attr("width",O+n.left+n.right).attr("height",F+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")"),d=.2*d3.max(o);a.domain([d3.min(o),d3.max(o)+d]),u.append("g").attr("class","x axis").attr("transform","translate(0,"+F+")").call(r),u.append("g").attr("class","y axis").call(i);u.selectAll(".points").data(s).enter().append("g");angular.forEach(s,function(n){var e=u.selectAll(".circle").data(n.values).enter();e.append("circle").attr("cx",function(n){return t(n.x)}).attr("cy",function(t){return a(t.y)}).attr("r",3).style("fill",E(s.indexOf(n))).style("stroke",E(s.indexOf(n))).on("mouseover",function(t){return function(n){k({index:n.x,value:n.y,series:t},d3.event),M.mouseover(n,d3.event),l.$apply()}}(n.series)).on("mouseleave",function(t){w(),M.mouseout(t,d3.event),l.$apply()}).on("mousemove",function(){$(d3.event)}).on("click",function(t){M.click(t,d3.event),l.$apply()}),M.labels&&e.append("text").attr("x",function(n){return t(n.x)}).attr("y",function(t){return a(t.y)}).text(function(t){return t.y})})}function k(t,n){if(M.tooltips){t="function"==typeof M.tooltips?M.tooltips(t):t.value;var a=angular.element('<p class="ac-tooltip" style="'+s+'"></p>').html(t).css({left:n.pageX+20,top:n.pageY-30});e.find("body").append(a),l.$tooltip=a}}function w(){l.$tooltip.remove()}function $(t){l.$tooltip.css({left:t.pageX+10+"px",top:t.pageY-15+"px"})}function C(){l.legends=[],"pie"==W&&angular.forEach(T,function(t,n){l.legends.push({color:M.colors[n],title:t.x})}),("bar"==W||"area"==W||"point"==W||"line"==W&&"traditional"===M.lineLegend)&&angular.forEach(D,function(t,n){l.legends.push({color:M.colors[n],title:t})})}function E(t){if(t<M.colors.length)return M.colors[t];var n=i();return M.colors.push(n),n}var M={title:"",tooltips:!0,labels:!1,mouseover:function(){},mouseout:function(){},click:function(){},legend:{display:!0,position:"left"},colors:["steelBlue","rgb(255,153,0)","rgb(220,57,18)","rgb(70,132,238)","rgb(73,66,204)","rgb(0,128,0)"],innerRadius:0,lineLegend:"lineEnd"},A=c[0].clientWidth,R=c[0].clientHeight;if(0===R||0===A)throw new Error("Please set height and width for the chart element");var B,D,T,F,O,H,L,W,z=M.colors;if(0===R||0===A)throw new Error("Please set height and width for the chart element");var P=angular.element(a),X=null;P.bind("resize",function(){X&&r.cancel(X),X=r(function(){A=c[0].clientWidth,R=c[0].clientHeight,u()},100)}),l.getWindowDimensions=function(){return{h:P[0].clientHeight,w:P[0].clientWidth}},l.$watch("acChart",function(){u()},!0),l.$watch("acData",function(){u()},!0),l.$watch("acConfig",function(){u()},!0)}var s=["display:block;","position:absolute;","border:1px solid #333;","background-color:#161616;","border-radius:5px;","padding:5px;","color:#fff;"].join("");return{restrict:"EA",link:l,transclude:"true",scope:{acChart:"=",acData:"=",acConfig:"="}}}]),angular.module("angularChartsTemplates",["left","right"]),angular.module("left",[]).run(["$templateCache",function(t){t.put("left","\n<style>\n .axis path,\n .axis line {\n   fill: none;\n   stroke: #333;\n }\n .ac-line {\n   fill:none;\n   stroke-width:2px;\n }\n</style>\n\n<div class='ac-title' style='font-weight: bold;font-size: 1.2em;'>{{acConfig.title}}</div>\n<div class='ac-legend' style='float:left; max-width:25%;' ng-show='{{acConfig.legend.display}}'>\n <table style='list-style:none;margin:0px;padding:0px;'>\n <tr ng-repeat=\"l in legends\">\n   <td><div ng-attr-style='background:{{l.color}}; height:15px;width:15px;'></div></td>\n   <td style=' display: inline-block;' ng-bind='l.title'></td>\n </tr>\n </table>\n</div>\n<div class='ac-chart' style='float:left; width:75%;'>\n</div>")}]),angular.module("right",[]).run(["$templateCache",function(t){t.put("right","<style>\n .axis path,\n .axis line {\n   fill: none;\n   stroke: #333;\n }\n .ac-line {\n   fill:none;\n   stroke-width:2px;\n }\n</style>\n\n<div class='ac-title' style='font-weight: bold;font-size: 1.2em;'>{{acConfig.title}}</div>\n<div class='ac-chart' style='float:left;width:75%;'>\n</div>\n<div class='ac-legend' style='float:left; max-width:25%;' ng-show='{{acConfig.legend.display}}'>\n <table style='list-style:none;margin:0px;padding:0px;'>\n <tr ng-repeat=\"l in legends | limitTo:yMaxData\">\n   <td><div ng-attr-style='background:{{l.color}}; height:15px;width:15px;'></div></td>\n   <td style=' display: inline-block;' ng-bind='l.title'></td>\n </tr>\n </table>\n</div>")}]);
"use strict";angular.module("drive",["ngRoute","good.ui.grid","drive.controllers","drive.services","drive.directives","drive.filters","ngCookies","angularCharts","ui.bootstrap"]).config(["$routeProvider","$locationProvider",function(t){t.when("/datagrid/attachment",{templateUrl:"partials/documentStatistic.html",controller:"AttachmentCtrl"}).when("/datagrid/attachmentActivity",{templateUrl:"partials/attachmentActivity.html",controller:"AttachmentActivityCtrl"}).when("/datagrid/device",{templateUrl:"partials/device.html",controller:"DeviceCtrl"}).when("/datagrid/deviceActivity",{templateUrl:"partials/deviceActivity.html",controller:"DeviceActivityCtrl"}).when("/datagrid/devicestatus",{templateUrl:"partials/data-map.html"}).when("/chart/attachmentChart",{templateUrl:"partials/chart.html",controller:"AttachmentChartCtrl"}).when("/chart/deviceChart",{templateUrl:"partials/chart.html",controller:"DeviceChartCtrl"}).when("/datagrid/userInfo",{templateUrl:"partials/userInfo.html",controller:"userAddCtrl"})}]).run(["$templateCache","$location","$cookieStore","$cookies","Constant",function(t,e,r,a,l){var i=e.hash()||e.$$path;if(i&&i.indexOf("server")>=0){var c=i.substring(i.indexOf("=")+1);r.put("server",c)}var c=r.get("server");c&&(l.serverUrl=c),console.log(c)}]);
"use strict";angular.module("drive.controllers",[]).controller("HeadCtrl",["$rootScope","$scope","HeadData",function(e,t,r){t.headList=r,t.setHead=function(e){r.forEach(function(e){e.className_=""}),r[e].className_="active",t.headList=r}}]).controller("MenuCtrl",["$rootScope","$scope","HeadData",function(e,t,r){t.headList=r,t.$watch("headList",function(){r.forEach(function(e){"active"==e.className_&&(t.menuList=e.menu)})},!0),t.setMenu=function(e){t.menuList.forEach(function(e){e.className_=""}),t.menuList[e].className_="active"}}]).controller("AttachmentActivityCtrl",["$scope","bus","Constant","PaginationService","millionFormat","$log","messageService",function(e,t,r,a,n,s,i){var o=1,c=5,u="drive_test",l="attachmentActivity",d=!0;e.title="文档操作管理";var h={action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},_=function(e){var t={match_all:{}};return(""!=e||0!=e.length)&&(t={multi_match:{query:'"'+e+'"',fields:["title","user","userId"]}}),t},f=function(t){var r=t.body().hits.hits;if(!r||0==r.length)return i.toast("查询不到新数据哦！"),void--o;for(var a=0;a<r.length;a++)r[a]._source.duration=n(r[a]._source.duration);e.$apply(function(){if(d||e.search_tx||r.reverse(),e.datas=r,0!==r.length){var t=[],a=[],n=[];for(var s in r[0]._source){switch(s){case"attachmentId":s="文件编码";break;case"open":s="打开时间";break;case"duration":s="持续时间";break;case"userId":s="设备MAC";break;case"title":s="文件标题";break;case"user":s="所属校园"}t.push(s)}for(var i=0;i<r.length;i++){for(var s in r[i]._source)n.push(r[i]._source[s]);a.push(n),n=[]}e.tableHeader=t,e.tableBody=a}})};t().send(r.search_channel,h,f),e.prePage=function(){if(1>=o&&(o=1),1==o)return void i.toast("已经是第一页了哦！");1!=o&&o--,d=!1;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[0]:null},c=angular.extend([],e.datas),u=n(c);if(u){var g=a.buildQuery({_uid:l+"#"+u._id},null,5,!1);e.search_tx?g={query:_(e.search_tx),from:5*(o-1),size:5}:(g.sort.pop(),g.sort.push({_uid:"desc"})),h.source=g,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.nextPage=function(){1>=o&&(o=1),d=!0;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[c-1]:null},u=angular.extend([],e.datas);if(u.length<c)return void i.toast("没有更多数据了哦！");o++;var g=n(u);if(g){var v=a.buildQuery({_uid:l+"#"+g._id},null,5,!0);e.search_tx&&(v={query:_(e.search_tx),from:5*(o-1),size:5}),h.source=v,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.searchClick=function(){d=!0,o=1,h=e.search_tx?{action:"search",_index:u,_type:l,source:{query:_(e.search_tx),from:0,size:5},search_type:"query_then_fetch",scroll:"5m"}:{action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}}]).controller("DeviceActivityCtrl",["$scope","bus","Constant","PaginationService","millionFormat","$log","messageService",function(e,t,r,a,n,s,i){var o=1,c=5,u="drive_test",l="deviceActivity",d=!0;e.title="设备操作管理";var h={action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},_=function(e){var t={match_all:{}};return(""!=e||0!=e.length)&&(t={multi_match:{query:'"'+e+'"',fields:["deviceId","address","user^2"]}}),t},f=function(t){var r=t.body().hits.hits;if(!r||0==r.length)return i.toast("查询不到新数据哦！"),void--o;for(var a=0;a<r.length;a++)r[a]._source.duration=n(r[a]._source.duration),r[a]._source.radius=Math.round(r[a]._source.radius);e.$apply(function(){if(d||e.search_tx||r.reverse(),e.datas=r,0!==r.length){var t=[],a=[],n=[];for(var s in r[0]._source){switch(s){case"code":s="编码";break;case"deviceId":s="MAC地址";break;case"user":s="学校";break;case"address":s="地址";break;case"open":s="开机时间";break;case"duration":s="持续时间";break;case"coordinates":s="经纬度";break;case"radius":s="精度"}t.push(s)}for(var i=0;i<r.length;i++){for(var s in r[i]._source)n.push(r[i]._source[s]);a.push(n),n=[]}e.tableHeader=t,e.tableBody=a}})};s.log(JSON.stringify(h)),t().send(r.search_channel,h,f),e.prePage=function(){if(1>=o&&(o=1),1==o)return void i.toast("已经是第一页了哦！");1!=o&&o--,d=!1;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[0]:null},c=angular.extend([],e.datas),u=n(c);if(u){var g=a.buildQuery({_uid:l+"#"+u._id},null,5,!1);e.search_tx?g={query:_(e.search_tx),from:5*(o-1),size:5}:(g.sort.pop(),g.sort.push({_uid:"desc"})),h.source=g,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.nextPage=function(){1>=o&&(o=1),d=!0;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[c-1]:null},u=angular.extend([],e.datas);if(u.length<c)return void i.toast("没有更多数据了哦！");o++;var g=n(u);if(g){var v=a.buildQuery({_uid:l+"#"+g._id},null,5,!0);e.search_tx&&(v={query:_(e.search_tx),from:5*(o-1),size:5}),h.source=v,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.searchClick=function(){d=!0,o=1,h=e.search_tx?{action:"search",_index:u,_type:l,source:{query:_(e.search_tx),from:0,size:5},search_type:"query_then_fetch",scroll:"5m"}:{action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}}]).controller("DeviceCtrl",["$scope","bus","Constant","PaginationService","millionFormat","$log","messageService",function(e,t,r,a,n,s,i){var o=1,c=5,u="drive_test",l="device",d=!0;e.loadingStatus=new Array(new Array,new Array),e.btnStatus=new Array(new Array,new Array),e.btnText=[],e.statusText=[],e.title="设备管理";var h={action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},_=function(e){var t={match_all:{}};return(""!=e||0!=e.length)&&(t={multi_match:{query:'"'+e+'"',fields:["owner^2","registAddress"]}}),t},f=function(t){var r=t.body().hits.hits;return r&&0!=r.length?void e.$apply(function(){e.datas=r,d||e.search_tx||r.reverse();var t=g(r);e.tableHeader=t.tableHeader,e.tableBody=t.tableBody}):(i.toast("查询不到新数据哦！"),void--o)},g=function(t){if(0!==t.length){var r=["MAC地址"],a=[],n=[];for(var s in t[0]._source)switch(s){case"code":r.push("设备编码");break;case"owner":r.push("使用学校");break;case"contact":r.push("联系方式");break;case"registAddress":r.push("注册地址")}for(var i=0;i<t.length;i++){n.push(t[i]._id);for(var s in t[i]._source){if("reset"==s||"lock"==s||"registCoordinates"==s||"radius"==s)break;n.push(t[i]._source[s])}a.push(n),n=[],e.btnText[i]=1==t[i]._source.reset?"取消":"重置",e.statusText[i]=0==t[i]._source.lock?"锁定":"解锁",e.loadingStatus[i]=new Array,e.btnStatus[i]=new Array,e.loadingStatus[i][0]=!1,e.loadingStatus[i][1]=!1,e.btnStatus[i][0]=!0,e.btnStatus[i][1]=!0}return{tableHeader:r,tableBody:a}}};t().send(r.search_channel,h,f),e.prePage=function(){if(1>=o&&(o=1),1==o)return void i.toast("已经是第一页了哦！");1!=o&&o--,d=!1;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[0]:null},c=angular.extend([],e.datas),u=n(c);if(u){var g=a.buildQuery({_uid:l+"#"+u._id},null,5,!1);e.search_tx?g={query:_(e.search_tx),from:5*(o-1),size:5}:(g.sort.pop(),g.sort.push({_uid:"desc"})),h.source=g,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.nextPage=function(){1>=o&&(o=1),d=!0;var n=function(e){return e&&angular.isArray(e)&&0!=e.length?e[c-1]:null},u=angular.extend([],e.datas);if(u.length<c)return void i.toast("没有更多数据了哦！");o++;var g=n(u);if(g){var v=a.buildQuery({_uid:l+"#"+g._id},null,5,!0);e.search_tx&&(v={query:_(e.search_tx),from:5*(o-1),size:5}),h.source=v,s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)}},e.searchClick=function(){d=!0,o=1,h=e.search_tx?{action:"search",_index:u,_type:l,source:{query:_(e.search_tx),from:0,size:5},search_type:"query_then_fetch",scroll:"5m"}:{action:"search",_index:u,_type:l,source:{sort:["_uid"],size:c}},s.log(JSON.stringify(h)),t().send(r.search_channel,h,f)},e.resetClick=function(a,n,s){e.loadingStatus[n][s]=!e.loadingStatus[n][s],e.btnStatus[n][s]=!e.btnStatus[n][s];var i={action:"get",_index:u,_type:l,_id:a};t().send(r.search_channel,i,function(a){0==s?a.body()._source.lock="锁定"==e.statusText[n]?1:0:a.body()._source.reset="重置"==e.btnText[n]?1:0;var i={action:"index",_index:u,_type:l,_id:a.body()._id,source:a.body()._source};console.log(i),t().send(r.search_channel,i,function(t){console.log(t.body()),e.$apply(function(){e.loadingStatus[n][s]=!e.loadingStatus[n][s],e.btnStatus[n][s]=!e.btnStatus[n][s],0==s?e.statusText[n]="锁定"==e.statusText[n]?"解锁":"锁定":e.btnText[n]="重置"==e.btnText[n]?"取消":"重置"})})})}}]).controller("AttachmentCtrl",["$scope","$modal","bus","Constant","PaginationService","millionFormat","$log","messageService",function(e,t,r,a,n,s,i,o){var c=1,u=5,l="drive_test",d="attachment",h=!0;e.deviceOpen=[],e.deviceData=[],e.openCount=[],e.openTime=[],e.attachmentType=[],e.title="文档播放统计哦";var _={action:"search",_index:l,_type:d,source:{sort:["_uid"],size:u}},f=function(e){var t={match_all:{}};return(""!=e||0!=e.length)&&(t={multi_match:{query:'"'+e+'"',fields:["title^2","tags"]}}),t},g=function(t){var r=t.body().hits.hits;return r&&0!=r.length?void e.$apply(function(){e.datas=r,h||e.search_tx||r.reverse();var t=v(r);e.tableHeader=t.tableHeader,e.tableBody=t.tableBody}):(o.toast("查询不到新数据哦！"),void--c)},v=function(e){if(0!==e.length){var t=["文档编号"],r=[],a=[];for(var n in e[0]._source)switch(n){case"title":t.push("文档标题")}for(var s=0;s<e.length;s++){a.push(e[s]._id);for(var n in e[s]._source){if("contentLength"==n||"url"==n||"thumbnail"==n||"tags"==n)break;a.push("contentType"==n?e[s]._source[n].split("/")[e[s]._source[n].split("/").length-1]:e[s]._source[n])}r.push(a),y(s,e[s]._id),a=[]}return{tableHeader:t,tableBody:r}}};r().send(a.search_channel,_,g),e.prePage=function(){if(1>=c&&(c=1),1==c)return void o.toast("已经是第一页了哦！");1!=c&&c--,h=!1;var t=function(e){return e&&angular.isArray(e)&&0!=e.length?e[0]:null},s=angular.extend([],e.datas),u=t(s);if(u){var l=n.buildQuery({_uid:d+"#"+u._id},null,5,!1);e.search_tx?l={query:f(e.search_tx),from:5*(c-1),size:5}:(l.sort.pop(),l.sort.push({_uid:"desc"})),_.source=l,i.log(JSON.stringify(_)),r().send(a.search_channel,_,g)}},e.nextPage=function(){1>=c&&(c=1),h=!0;var t=function(e){return e&&angular.isArray(e)&&0!=e.length?e[u-1]:null},s=angular.extend([],e.datas);if(s.length<u)return void o.toast("没有更多数据了哦！");c++;var l=t(s);if(l){var v=n.buildQuery({_uid:d+"#"+l._id},null,5,!0);e.search_tx&&(v={query:f(e.search_tx),from:5*(c-1),size:5}),_.source=v,i.log(JSON.stringify(_)),r().send(a.search_channel,_,g)}},e.searchClick=function(){h=!0,c=1,_=e.search_tx?{action:"search",_index:l,_type:d,source:{query:f(e.search_tx),from:0,size:5},search_type:"query_then_fetch",scroll:"5m"}:{action:"search",_index:l,_type:d,source:{sort:["_uid"],size:u}},i.log(JSON.stringify(_)),r().send(a.search_channel,_,g)};var y=function(t,n){var s={size:0,query:{term:{attachmentId:n}},facets:{tag:{terms:{fields:["userId"],size:1e8}}}},i={action:"search",_index:l,_type:"attachmentActivity",source:s};r().send(a.search_channel,i,function(r){for(var a=r.body().facets.tag.terms,n=0,s=0;s<a.length;s++)n+=a[s].count;e.$apply(function(){e.deviceData[t]=a,e.deviceOpen[t]=a.length,e.openCount[t]=n})})};e.detailClick=function(t){var r="",a=e.deviceData[t];for(var n in a)r=r+"设备号:"+a[n].term+"  播放数:"+a[n].count+"</br>";o.toast(r)};var p=function(e,t,r){e.items=r,e.cancel=function(){t.dismiss("cancel")}};e.open=function(r){t.open({templateUrl:"myModalContent.html",controller:p,size:"lg",resolve:{items:function(){return e.deviceData[r]}}})}}]).controller("AttachmentChartCtrl",["$rootScope","$scope","bus","Constant","DateService",function(e,t,r,a,n){var s="drive_test";t.data={series:["所有文件播放次数"],data:[]};for(var i=function(e){var i=n.getWeekDate(e),o={size:0,query:{range:{open:{gte:i,lte:i}}},facets:{tag:{terms:{fields:["attachmentId"],size:3}}}},c={action:"search",_index:s,_type:"attachmentActivity",source:o};r().send(a.search_channel,c,function(r){{var a=r.body().hits.total;r.body().facets.tag.terms}t.$apply(function(){t.data.data[e-1]={x:n.getFormatDate(new Date(i)),y:[a]}})})},o=1;8>o;o++)i(o);t.chartType="line",t.config={labels:!1,title:"文件播放统计图 第 "+n.getWeekNo()+" 周",legend:{display:!0,position:"right"},lineLegend:"traditional"}}]).controller("DeviceChartCtrl",["$rootScope","$scope","bus","Constant","DateService",function(e,t,r,a,n){var s="drive_test";t.data={series:["所有设备开机次数"],data:[]};for(var i=function(e){var i=n.getWeekDate(e),o={size:0,query:{range:{open:{gte:i,lte:i}}},facets:{tag:{terms:{fields:["deviceId"],size:3}}}},c={action:"search",_index:s,_type:"deviceActivity",source:o};r().send(a.search_channel,c,function(r){{var a=r.body().hits.total;r.body().facets.tag.terms}t.$apply(function(){t.data.data[e-1]={x:n.getFormatDate(new Date(i)),y:[a]}})})},o=1;8>o;o++)i(o);t.chartType="line",t.config={labels:!1,title:"设备开机统计图 第 "+n.getWeekNo()+" 周",legend:{display:!0,position:"right"},lineLegend:"traditional"}}]).controller("userAddCtrl",["$scope",function(e){e.title="用户信息",e.resetUser=function(){e.user=""},e.saveUser=function(){e.resetUser()}}]);
"use strict";angular.module("drive.directives",["drive.controllers"]).directive("helloworld",function(){return{restrict:"E",controller:"Ctrl2",replace:"true",templateUrl:"partials/helloworldDirective.html"}}).directive("toast",["$timeout","$interval","$window",function(e,t,o){var n=!0,i=function(e,o){o.on("mouseover",function(){n=!1}),o.on("mouseout",function(){n=!0});var i=t(function(){n&&(o.remove(),t.cancel(i))},2e3)};return{restrict:"EA",transclude:!0,templateUrl:"partials/messageDirective.html",compile:function(e){var t=o.screen.height,n=o.screen.width;console.log(t+"---"+n);var r=e[0].firstChild.offsetWidth,c=e[0].firstChild.offsetHeight;return e.find("div").css({top:(t-c)/2+"px",left:(n-r)/2+"px"}),i}}}]).directive("goodMap",["Constant","bus","$window",function(e,t,o){function n(n,i){function r(){var o={action:"search",_index:"drive_test",_type:"deviceStatus",source:{size:1e4,query:{term:{status:"login"}}}};t().send(e.search_channel,o,function(e){var t=e.body().hits.hits;t&&0!=t.length&&n.$apply(function(){n.mapInfos=t})})}function c(){var e={center:new google.maps.LatLng(39.92,116.46),zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP};i.css({height:o.screen.height+"px"}),l=new google.maps.Map(i[0],e),r()}function s(e,t,o,n){if(u)for(var i in u)if(u[i].getTitle()==o)return void u[i].setIcon(d);var r=new google.maps.Marker({position:new google.maps.LatLng(e,t),title:o,icon:d,map:l}),c=new google.maps.InfoWindow({content:n});google.maps.event.addListener(r,"mouseover",function(){c.open(l,r)}),u.push(r)}function a(e){if(u)for(var t in u)u[t].getTitle()==e&&u[t].setIcon()}var l,u=[],d="img/markerIcon.png";t().registerHandler("drive/devicestatus",function(e){n.$apply(function(){n.mapInfo=e.body()})}),n.$watch("mapInfo",function(e,t){e!==t&&"[]"!==e&&("login"==e.status?s(e.coordinates[1],e.coordinates[0],e.deviceId,e.owner):"logout"==e.status&&a(e.deviceId))}),n.$watch("mapInfos",function(e,t){if(e!==t&&0!=e.length)for(var o in e)s(e[o]._source.coordinates[1],e[o]._source.coordinates[0],e[o]._source.deviceId,e[o]._source.owner)}),c()}return{restrict:"A",link:n,replace:!0}}]);
"use strict";angular.module("drive.filters",[]);
"use strict";angular.module("drive.services",[]).factory("bus",["$window","Constant",function(t,e){var a={debug:!0,forkLocal:!0},r=e.serverUrl,n=new t.realtime.channel.ReconnectBus(r,a);return function(){return n}}]).factory("HeadData",function(){var t=[{type:"/chart/attachmentChart",name:"文档统计"},{type:"/chart/deviceChart",name:"设备统计"}],e=[{type:"/datagrid/attachment",name:"文档播放统计"},{type:"/datagrid/attachmentActivity",name:"文档操作管理"},{type:"/datagrid/device",name:"设备管理"},{type:"/datagrid/deviceActivity",name:"设备操作管理"},{type:"/datagrid/devicestatus",name:"设备在线显示"}],a=[{type:"/datagrid/userInfo",name:"添加用户"},{type:"/datagrid/userList",name:"查看用户"}],r=[{type:"profile1",name:"个人中心1"},{type:"profile2",name:"个人中心2"}],n={menu:t,name:"统计报表",className_:"active"},o={menu:e,name:"系统管理",className_:""},u={menu:a,name:"用户管理",className_:""},s={menu:r,name:"个人中心",className_:""},i=[];return i.push(n),i.push(o),i.push(u),i.push(s),i}).factory("millionFormat",function(){return function(t){var e=parseInt(t),a=0,r=0,n=0;e>60&&(a=parseInt(e/60),e=parseInt(e%60),a>60&&(r=parseInt(a/60),a=parseInt(a%60),r>24&&(n=parseInt(r/24),r=parseInt(a%24))));var o=""+parseInt(e)+"秒";return a>0&&(o=""+parseInt(a)+"分"+o),r>0&&(o=""+parseInt(r)+"小时"+o),n>0&&(o=""+parseInt(n)+"天"+o),o}}).factory("Constant",function(){return{host:"test.goodow.com",search_channel:"realtime/search",serverUrl:"http://test.goodow.com:1986/channel"}}).factory("PaginationService",function(){var t={query:{bool:{should:[{bool:{must:[{term:{}},{range:{}}]}},{range:{}}],minimum_should_match:1}},size:5,sort:[]},e={query:{bool:{must:[{range:{}}]}},size:5,sort:[]};return{buildQuery:function(a,r,n,o){if(n&&(e.size=n,t.size=n),r){if(o)for(var u in a){t.query.bool.should[0].bool.must[0].term[u]=a[u],t.sort[0]=u;var s={};s.gt=a[u],t.query.bool.should[1].range[u]=s;for(var i in r){t.sort[1]=i;var g={};g.gt=r[i],t.query.bool.should[0].bool.must[1].range[i]=g}}else for(var u in a){t.query.bool.should[0].bool.must[0].term[u]=a[u];var g={};g[u]="desc",t.sort[0]=g;var c={};c.lt=a[u],t.query.bool.should[1].range[u]=c;for(var i in r){t.sort[1]=i;var s={};s.gt=r[i],t.query.bool.should[0].bool.must[1].range[i]=s}}return t}if(o)for(var u in a){var g={};g.gt=a[u],e.query.bool.must[0].range[u]=g,e.sort[0]=u}else for(var u in a){var g={};g.lt=a[u],e.query.bool.must[0].range[u]=g;var g={};g[u]="desc",e.sort[0]=g}return e}}}).factory("messageService",["$document","$log","$timeout","$compile","$rootScope","$window",function(t,e,a,r,n){return{toast:function(e){var a=angular.element("<toast>"+e+"</toast>");t.find("body").append(a);var o=n.$new(!1);o.toastTitle="提示",r(a)(o)}}}]).factory("DateService",function(){var t=new Date,e=(t.getDay(),t.getDate(),t.getMonth()),a=t.getYear();a+=2e3>a?1900:0;var r=new Date;r.setDate(1),r.setMonth(r.getMonth()-1);var n=(r.getYear(),r.getMonth()),o=function(t){var e=t.getFullYear(),a=t.getMonth()+1,r=t.getDate();return 10>a&&(a="0"+a),10>r&&(r="0"+r),e+"-"+a+"-"+r};return{getWeekNo:function(){var t=0,e=new Date,a=e.getYear();1e3>a&&(a+=1900);var r=new Array(12);if(r[0]=31,r[2]=31,r[3]=30,r[4]=31,r[5]=30,r[6]=31,r[7]=31,r[8]=30,r[9]=31,r[10]=30,r[11]=31,r[1]=Math.round(e.getYear()/4)==e.getYear()/4?29:28,0==e.getMonth())t+=e.getDate();else{for(var n=e.getMonth(),o=1;n>=o;o++)t+=r[o-1];t+=e.getDate()}var u=Math.round(t/7);return u},getFormatDate:function(t){var e=(t.getFullYear(),t.getMonth()+1),a=t.getDate();return 10>e&&(e="0"+e),10>a&&(a="0"+a),e+"."+a},getMonthDays:function(t){var e=new Date(a,t,1),r=new Date(a,t+1,1),n=(r-e)/864e5;return n},getQuarterStartMonth:function(){var t=0;return 3>e&&(t=0),e>2&&6>e&&(t=3),e>5&&9>e&&(t=6),e>8&&(t=9),t},getWeekStartDate:function(){var t=new Date;return o(new Date(t.setDate(t.getDate()-t.getDay()+1)))},getWeekEndDate:function(){var t=new Date;return o(new Date(t.setDate(t.getDate()-t.getDay()+7)))},getWeekDate:function(t){var e=new Date;return o(new Date(e.setDate(e.getDate()-e.getDay()+t)))},getMonthStartDate:function(){var t=new Date(a,e,1);return o(t)},getMonthEndDate:function(){var t=new Date(a,e,getMonthDays(e));return o(t)},getLastMonthStartDate:function(){var t=new Date(a,n,1);return o(t)},getLastMonthEndDate:function(){var t=new Date(a,n,getMonthDays(n));return o(t)},getQuarterStartDate:function(){var t=new Date(a,getQuarterStartMonth(),1);return o(t)},getQuarterEndDate:function(){var t=getQuarterStartMonth()+2,e=new Date(a,t,getMonthDays(t));return o(e)}}});